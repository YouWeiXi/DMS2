<script src="/javascripts/page.js"></script>
<div class="modal fade" id="new-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">
                    广告添加
                </h4>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs">
                    <li role="presentation" class="active"><a href="#new" data-toggle="tab">新建</a></li>
                    <li role="presentation"><a href="#datalist" data-toggle="tab">列表</a></li>
                </ul>
                <br/>
                <div class="tab-content">
                    <div class="tab-pane fade in active" id="new">
                        <form id="add-form" class="form-horizontal" role="form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label class="col-sm-2 control-label"><span style="color: red;">*&nbsp;&nbsp;&nbsp;&nbsp;</span>类型</label>
                                <div class="col-sm-10">
                                    <select id="new-type">
                                        <option value='agent'>代理公司</option>
                                        <option value='builder'>设计搭建公司</option>
                                        <option value='transport'>物流公司</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Logo 小图</label>
                                <div class="col-sm-10">
                                    <input type="file"  name="ad-new-logofile-small" id="ad-new-logofile-small"/>
                                </div>
                                <div id="ad-new-previewdiv-small" class="col-xs-6 col-md-3 hide">
                                    <a href="#" class="thumbnail">
                                        <img id="ad-new-preview-small" src=""  alt="">
                                    </a>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Logo 大图</label>
                                <div class="col-sm-10">
                                    <input type="file"  name="ad-new-logofile-big" id="ad-new-logofile-big"/>
                                </div>
                                <div id="ad-new-previewdiv-big" class="col-xs-6 col-md-3 hide">
                                    <a href="#" class="thumbnail">
                                        <img id="ad-new-preview-big" src=""  alt="">
                                    </a>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">名称</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control hide" id="new-_id">
                                    <input type="text" class="form-control" id="new-name" placeholder="请输入广告名称">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">URL</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-url" placeholder="请输入URL">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">标签</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-tags" placeholder="请输入广告标签">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">联系人</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-contact" placeholder="请输入广告内容">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">电话</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-tel" placeholder="请输入联系电话">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">传真</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-fax" placeholder="请输入传真">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Email</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-email" placeholder="请输入Email">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">QQ</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="new-qq" placeholder="请输入QQ">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="datalist">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search for..." id="search">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" type="button" id="search-btn">Go!</button>
                                    </span>
                                </div><!-- /input-group -->
                            </div><!-- /.col-lg-6 -->
                        </div>
                        <br>
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <td>类型</td>
                                <td>Logo</td>
                                <td>名称</td>
                                <td>URL</td>
                                <td>标签</td>
                                <td>操作</td>
                            </tr>
                            </thead>
                            <tbody id="datalistbody"></tbody>
                        </table>
                        <div class="text-right">
                            <nav>
                                <ul class="pagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button>
                <button type="button" class="btn btn-primary" id="ad-save-btn">
                    保存
                </button>
            </div>
        </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal -->
<div class="modal fade" id="edit-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 id="adModalLabel" class="modal-title">
                    广告更新
                </h4>
            </div>
            <div class="modal-body">
                <form id="edit-form" class="form-horizontal" role="form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Logo 小图</label>
                        <div class="col-sm-10">
                            <input type="file"  name="ad-edit-logofile-small" id="ad-edit-logofile-small"/>
                        </div>
                        <div id="ad-edit-previewdiv-small" class="col-xs-6 col-md-3 hide">
                            <a href="#" class="thumbnail">
                                <img id="ad-edit-preview-small" src=""  alt="">
                            </a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Logo 大图</label>
                        <div class="col-sm-10">
                            <input type="file"  name="ad-edit-logofile-big" id="ad-edit-logofile-big"/>
                        </div>
                        <div id="ad-edit-previewdiv-big" class="col-xs-6 col-md-3 hide">
                            <a href="#" class="thumbnail">
                                <img id="ad-edit-preview-big" src=""  alt="">
                            </a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">类型</label>
                        <div class="col-sm-10">
                            <select id="edit-type">
                                <option value='agent'>代理公司</option>
                                <option value='builder'>设计搭建公司</option>
                                <option value='transport'>物流公司</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">名称</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control hide" id="edit-_id">
                            <input type="text" class="form-control" id="edit-name" placeholder="请输入广告名称">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">URL</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-url" placeholder="请输入URL">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">标签</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-tags" placeholder="请输入广告标签">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">联系人</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-contact" placeholder="请输入广告内容">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">电话</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-tel" placeholder="请输入联系电话">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">传真</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-fax" placeholder="请输入传真">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Email</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-email" placeholder="请输入Email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">QQ</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="edit-qq" placeholder="请输入QQ">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button>
                <button type="button" class="btn btn-primary" id="ad-edit-btn">
                    保存
                </button>
            </div>
        </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal -->
<div class="modal fade" style="width: auto" id="remove_modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">
                    选择删除广告类型
                </h4>
            </div>
            <div class="modal-body">
                请慎重选择，可从广告管理中查看关联展会列表
                <p/>
                <button type="button" class="btn btn-danger" id="ad-remove-btn">
                    删除广告,及移除所有展会与此广告的关系
                </button>
                <button type="button" class="btn btn-primary" id="fair-remove-btn">
                    仅删除当前展会与此广告的关系
                </button>
                <p/>
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button>
            </div>
        </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal -->
<script id="ad-list-template" type="text/x-handlebars-template">
    {{#each this.list}}
    <tr>
        <td>
            {{#compare type "agent"}}
            代理公司
            {{/compare}}
            {{#compare type "builder"}}
            设计搭建公司
            {{/compare}}
            {{#compare type  "transport"}}
            物流公司
            {{/compare}}
        </td>
        <td>
            {{#if pic}}
            <div style="width:100px;heigh:100px">
                <a href="#" class="thumbnail">
                    <img src="/user_data/{{pic.small}}">
                </a>
            </div>
            {{/if}}
        </td>
        <td>{{name}}</td>
        <td>{{url}}</td>
        <td>{{tags}}</td>
        <td>
            <a onclick="updateFairAd('{{_id}}')"><span class="glyphicon glyphicon-plus"/></a>
        </td>
    </tr>
    {{/each}}
</script>
<script>
    function edit(id){
        /*
        //如果存在图片
        if($('#pic'+id)[0]){
            $('#ad-edit-previewdiv').addClass('show')
            $('#ad-edit-preview').attr('src',$('#pic'+id)[0].src);
        }*/
        $('#edit-_id').val(id);
        $('#edit-name').val($('#name'+id).html());
        $('#edit-contact').val($('#contact'+id).html());
        $('#edit-tags').val($('#tags'+id).html());
        $('#edit-url').val($('#url'+id).html());
        $('#edit-tel').val($('#tel'+id).html());
        $('#edit-fax').val($('#fax'+id).html());
        $('#edit-email').val($('#email'+id).html());
        $('#edit-qq').val($('#qq'+id).html());
    }
    $('#ad-save-btn').on('click',function(){
        update('new-')
    })
    $('#ad-edit-btn').on('click',function(){
        update('edit-')
    })
    function update(prefix){
        var type=$('#'+prefix+'type').val();
        var id=$('#'+prefix+'_id').val();
        var url='/ad/save';
        var param={
            type:type,
            name:$('#'+prefix+'name').val(),
            contact:$('#'+prefix+'contact').val(),
            tags:$('#'+prefix+'tags').val(),
            url:$('#'+prefix+'url').val(),
            tel:$('#'+prefix+'tel').val(),
            fax:$('#'+prefix+'fax').val(),
            email:$('#'+prefix+'email').val(),
            qq:$('#'+prefix+'qq').val()
        };
        if(id){
            url='/ad/update';
            param._id=id;
        }else{
            param.fairId=fairId;
        }
        var formdata = new FormData($("#"+prefix+"form")[0]);
        for(var k in param){
            formdata.append(k, param[k]);
        }
        $.ajax({
            type:'POST',
            url: url,
            data:formdata,
            processData: false,
            contentType: false,
            success: function(data){
                alert("保存成功");
                $('#'+prefix+'modal').modal("hide")
                loadPage(1)
            }
        })
    }
    $('.nav-tabs a').click(function (e) {
        $(this).tab('show')
        if($(this).attr('href')=='#datalist'){
            loadAds()
        }
    })
    function loadAds(search){
        var param={};
        if(search){
            param.search=search;
        }
        $.ajax({
            type : "GET",
            url : "/ad/find",
            data:param,
            success: function(data) {
                var obj = data;
                if(obj.status=="200"){
                    $('#datalistbody').handlebars($('#ad-list-template'), obj.data);
                    page(obj.data.count,'loadAds')
                }else{
                    alert('加载失败。')
                }
            }
        });
    }
    $('#ad-new-logofile-small').on('change', function() {
        preview('ad-new-','-small')
    });
    $('#ad-edit-logofile-small').on('change', function() {
        preview('ad-edit-','-small')
    });
    $('#ad-new-logofile-big').on('change', function() {
        preview('ad-new-','-big')
    });
    $('#ad-edit-logofile-big').on('change', function() {
        preview('ad-edit-','-big')
    });
    $('#new-modal').on('hide', function() {
        clear('new-')
    });
    $('#edit-modal').on('hide', function() {
        $('#edit-_id').val('');
        clear('edit-')
    });
    function clear(prefix){
        $('#'+prefix+'name').val('');
        $('#'+prefix+'contact').val('');
        $('#'+prefix+'tags').val('');
        $('#'+prefix+'url').val('');
        $('#'+prefix+'tel').val('');
        $('#'+prefix+'fax').val('');
        $('#'+prefix+'email').val('');
        $('#'+prefix+'qq').val('');

        //清空图片
        $('#ad-'+prefix+'-logofile-big').val('');
        $('#ad-'+prefix+'previewdiv-big').removeClass('show')
        $('#ad-'+prefix+'preview-big').attr('src','');
        $('#ad-'+prefix+'-logofile-small').val('');
        $('#ad-'+prefix+'previewdiv-small').removeClass('show')
        $('#ad-'+prefix+'preview-small').attr('src','');
    }
    function preview(prefix,suffix){
        var f = document.getElementById(prefix+"logofile"+suffix).files[0];
        var src = window.URL.createObjectURL(f);
        $('#'+prefix+'previewdiv'+suffix).addClass('show')
        $('#'+prefix+'preview'+suffix).attr('src',src);
    }
    function updateFairAd(adId){
        $.get("/fair/addAd",{adId:adId,fairId:fairId,type:$('#new-type').val()}, function(result){
            loadPage()
        });
    }
    $('#search-btn').on('click',function(){
        loadAds($('#search').val())
    })
    $('#ad-remove-btn').on('click',function(){
        $.get("/ad/remove",{_id:curr_adId,fairId:fairId,type:$('#type'+curr_adId).attr('data-val')}, function(result){
            $('#remove_modal').modal("hide")
            loadPage()
        });
    })
    $('#fair-remove-btn').on('click',function(){
        $.get("/fair/removeAd",{adId:curr_adId,fairId:fairId,type:$('#type'+curr_adId).attr('data-val')}, function(result){
            $('#'+curr_adId).remove()
            $('#remove_modal').modal("hide")
        });
    })
    var curr_adId=null;
    $('#remove_modal').on('hide', function() {
        curr_adId=null;
    });
    function del(adId){
        curr_adId=adId;
    }
</script>